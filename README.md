# æ‰“é€ ä¸€ä¸ª NestJS é£Žæ ¼æ¡†æž¶



> ðŸï¸ NestJS æ˜¯ç”¨äºŽæž„å»ºé«˜æ•ˆã€å¯é å’Œå¯æ‰©å±•çš„æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºçš„æ¡†æž¶ï¼Œä½¿ç”¨ TypeScript ç¼–å†™çš„ï¼Œç»“åˆäº†é¢å‘å¯¹è±¡ç¼–ç¨‹ï¼ˆOOPï¼‰ã€å‡½æ•°å¼ç¼–ç¨‹ï¼ˆFPï¼‰å’Œå‡½æ•°å“åº”å¼ç¼–ç¨‹ï¼ˆFRPï¼‰çš„ç‰¹æ€§ï¼Œæ˜¯éžå¸¸æµè¡Œçš„ Node.js æœåŠ¡ç«¯æ¡†æž¶ã€‚æœ¬æ–‡ç®€ç•¥ä»‹ç»å¦‚ä½•åˆ¶ä½œä¸€ä¸ª NestJS é£Žæ ¼çš„ mini æ¡†æž¶ã€‚
>



##  æ‰€è°“è®¾è®¡æ¨¡å¼

AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰ã€IoCï¼ˆæŽ§åˆ¶åè½¬ï¼‰å’Œ OOPï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰æ˜¯è½¯ä»¶å¼€å‘ä¸­çš„ä¸‰ä¸ªæ¦‚å¿µï¼Œå®ƒä»¬åœ¨æž„å»ºå¤æ‚è½¯ä»¶ç³»ç»Ÿæ—¶ç›¸äº’å…³è”å¹¶ä¸”äº’è¡¥ã€‚
1. **OOPï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰**:
	- OOP æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œå®ƒä½¿ç”¨â€œå¯¹è±¡â€æ¥è®¾è®¡åº”ç”¨ç¨‹åºã€‚å¯¹è±¡å¯ä»¥åŒ…å«æ•°æ®ï¼ˆå±žæ€§ï¼‰å’Œä»£ç ï¼ˆæ–¹æ³•ï¼‰ã€‚OOP çš„ä¸»è¦ç‰¹ç‚¹åŒ…æ‹¬å°è£…ã€ç»§æ‰¿å’Œå¤šæ€ã€‚
	- å°è£…éšè—äº†å¯¹è±¡çš„å†…éƒ¨çŠ¶æ€ï¼Œå¹¶é€šè¿‡å…¬å…±æ–¹æ³•æš´éœ²è¡Œä¸ºã€‚
	- ç»§æ‰¿å…è®¸æ–°çš„å¯¹è±¡ç±»ä»ŽçŽ°æœ‰çš„å¯¹è±¡ç±»ç»§æ‰¿å±žæ€§å’Œæ–¹æ³•ã€‚
	- å¤šæ€å…è®¸ä¸åŒç±»çš„å¯¹è±¡è¢«è§†ä¸ºåŒä¸€ç±»åž‹çš„å®žä¾‹ï¼Œä½¿å¾—å¯ä»¥ç”¨ç»Ÿä¸€çš„æ–¹å¼å¤„ç†ä¸åŒç±»åž‹çš„å¯¹è±¡ã€‚
2. **IoCï¼ˆæŽ§åˆ¶åè½¬ï¼‰**:
	- IoC æ˜¯ä¸€ç§è®¾è®¡åŽŸåˆ™ï¼Œç”¨äºŽå‡å°‘ä»£ç ä¹‹é—´çš„è€¦åˆã€‚åœ¨ä¼ ç»Ÿçš„ç¼–ç¨‹å®žè·µä¸­ï¼Œä»£ç ï¼ˆå¦‚å¯¹è±¡ï¼‰é€šå¸¸è‡ªè¡Œåˆ›å»ºå’Œç®¡ç†å®ƒä»¬çš„ä¾èµ–å…³ç³»ã€‚åœ¨ IoC ä¸­ï¼Œè¿™ç§æŽ§åˆ¶è¢«åè½¬ï¼šå¯¹è±¡çš„åˆ›å»ºå’Œä¾èµ–å…³ç³»çš„ç®¡ç†äº¤ç»™å¤–éƒ¨å®¹å™¨æˆ–æ¡†æž¶ã€‚
	- ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰æ˜¯å®žçŽ° IoC çš„ä¸€ç§æ–¹æ³•ï¼Œå®ƒå…è®¸å°†ä¾èµ–å…³ç³»ï¼ˆå¦‚æœåŠ¡ã€é…ç½®ï¼‰åŠ¨æ€åœ°æ³¨å…¥åˆ°ç»„ä»¶ä¸­ï¼Œè€Œä¸æ˜¯ç”±ç»„ä»¶è‡ªå·±åˆ›å»ºã€‚
	- IoC å®¹å™¨è´Ÿè´£å®žä¾‹åŒ–å¯¹è±¡ã€ç®¡ç†å®ƒä»¬çš„ç”Ÿå‘½å‘¨æœŸå’Œæ³¨å…¥ä¾èµ–å…³ç³»ã€‚
3. **AOPï¼ˆé¢å‘åˆ‡é¢ç¼–ç¨‹ï¼‰**:
	- AOP æ˜¯ä¸€ç§ç¼–ç¨‹èŒƒå¼ï¼Œå®ƒå…è®¸å¼€å‘è€…å°†æ¨ªåˆ‡å…³æ³¨ç‚¹ï¼ˆå¦‚æ—¥å¿—è®°å½•ã€äº‹åŠ¡ç®¡ç†ã€å®‰å…¨ç­‰ï¼‰ä»Žä¸šåŠ¡é€»è¾‘ä¸­åˆ†ç¦»å‡ºæ¥ã€‚
	- åœ¨ AOP ä¸­ï¼Œè¿™äº›æ¨ªåˆ‡å…³æ³¨ç‚¹è¢«å°è£…åˆ°â€œåˆ‡é¢â€ä¸­ï¼Œåˆ‡é¢å¯ä»¥åœ¨ç¨‹åºçš„ä¸åŒç‚¹ï¼ˆç§°ä¸ºâ€œè¿žæŽ¥ç‚¹â€ï¼‰è¢«åŠ¨æ€åœ°åº”ç”¨ã€‚
	- AOP æé«˜äº†ä»£ç çš„æ¨¡å—åŒ–ï¼Œä½¿å¾—æ¨ªåˆ‡å…³æ³¨ç‚¹çš„ç»´æŠ¤å’Œé‡ç”¨å˜å¾—æ›´åŠ å®¹æ˜“ã€‚

**å…³ç³»**:
- **AOP ä¸Ž OOP çš„å…³ç³»**ï¼šOOP æä¾›äº†æž„å»ºåº”ç”¨ç¨‹åºçš„åŸºç¡€ç»“æž„ï¼Œè€Œ AOP å’Œ IOC æ˜¯åœ¨ OOP åŸºç¡€ä¸Šæå‡ºçš„ä¸¤ç§é«˜çº§æ¦‚å¿µï¼Œç”¨äºŽè§£å†³ OOP åœ¨å¤„ç†æŸäº›ç±»åž‹çš„é—®é¢˜æ—¶çš„å±€é™æ€§ã€‚
- **AOP ä¸Ž IoC çš„å…³ç³»**ï¼šAOP å¯ä»¥ä¸Ž IoC å®¹å™¨ååŒå·¥ä½œã€‚ä¾‹å¦‚ï¼ŒAOP åˆ‡é¢å¯ä»¥é€šè¿‡ IoC å®¹å™¨è¿›è¡Œé…ç½®å’Œç®¡ç†ï¼Œåˆ‡é¢ä¸­çš„ä¾èµ–å…³ç³»å¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥æ¥è§£å†³ã€‚
- **ç›¸äº’è¡¥å……**ï¼šAOP å’Œ IoC éƒ½æ˜¯ä¸ºäº†æé«˜ä»£ç çš„å¯ç»´æŠ¤æ€§å’Œå¯æ‰©å±•æ€§ã€‚IoC é€šè¿‡æŽ§åˆ¶åè½¬æ¥ç®¡ç†å¯¹è±¡çš„åˆ›å»ºå’Œä¾èµ–ï¼Œè€Œ AOP é€šè¿‡åˆ‡é¢æ¥ç®¡ç†æ¨ªåˆ‡å…³æ³¨ç‚¹ã€‚å®ƒä»¬éƒ½æ˜¯åœ¨ OOP çš„åŸºç¡€ä¸Šæä¾›é¢å¤–çš„ç»“æž„å’Œæ¨¡å¼ï¼Œä»¥ä¾¿æ›´å¥½åœ°ç»„ç»‡å’Œç®¡ç†å¤æ‚çš„ä»£ç ã€‚

åœ¨çŽ°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œè¿™äº›æ¦‚å¿µç»å¸¸è¢«ç»¼åˆä½¿ç”¨ï¼Œç‰¹åˆ«æ˜¯åœ¨ä½¿ç”¨å¦‚ Springã€NestJS ç­‰æ¡†æž¶æ—¶ï¼Œå®ƒä»¬æä¾›äº†å¯¹è¿™äº›æ¦‚å¿µçš„å†…ç½®æ”¯æŒï¼Œä½¿å¾—å¼€å‘è€…å¯ä»¥æ›´åŠ ä¸“æ³¨äºŽä¸šåŠ¡é€»è¾‘çš„å®žçŽ°ã€‚



### IoC & DI

IoC åˆ°åº•æ˜¯ä»€ä¹ˆæœ‰ä»€ä¹ˆç”¨ï¼Œå¯ä»¥é€šè¿‡ä¸€ä¸ªç®€å•çš„ä¾‹å­è¯´æ˜Žã€‚

```ts
class Wing {}

class Bird {
  private wing: Wing

  constructor () {
    this.wing = new Wing()
  }
}

const bird = new Bird()
```
`Bird` ç±»ä¾èµ–äºŽ `Wing` ç±»ï¼Œå¦‚æžœ `Wing` ç±»æœ‰ä¿®æ”¹ï¼Œåˆ™ä¼šå½±å“ `Bird` ç±»ï¼Œå¦‚æžœä¾èµ–çš„å±‚çº§è¶Šæ·±ï¼Œæ¯ä¿®æ”¹ä¸€ä¸ªåº•å±‚çš„ç±»ç»™ä¸Šå±‚ç±»å¸¦æ¥çš„å½±å“å°†æ˜¯æ¯ç­æ€§çš„ï¼ˆä»£ç åŠå…¶éš¾ç»´æŠ¤ï¼‰ã€‚

`IoC` çš„æ€æƒ³å°±æ˜¯å°†ç±»çš„ä¾èµ–åŠ¨æ€æ³¨å…¥ï¼Œä½¿å¾—åº•å±‚çš„ç±»çš„ä¿®æ”¹ä¸ä¼šå½±å“åˆ°ä¾èµ–å®ƒçš„ç±»ï¼š
```ts
class Wing {}

class Bird {
  private wing: Wing

  constructor (wing) {
    this.wing = wing
  }
}

const wing = new Wing()
const bird = new Bird(wing) // å°†å®žä¾‹åŒ–çš„ wing ä¼ å…¥ Bird ç±»
```
è¿™æ ·ï¼Œæˆ‘ä»¬ä¾¿å®žçŽ°äº†ç±»çš„**æŽ§åˆ¶åè½¬**ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬éœ€è¦æœ‰ä¸€ä¸ªå®¹å™¨æ¥ç»´æŠ¤å„ä¸ªå¯¹è±¡å®žä¾‹ï¼Œå½“ç”¨æˆ·éœ€è¦ä½¿ç”¨å®žä¾‹æ—¶ï¼Œå®¹å™¨ä¼šè‡ªåŠ¨å°†å¯¹è±¡å®žä¾‹åŒ–ç»™ç”¨æˆ·ã€‚
```ts
import { Container, Service } from 'typedi'

@Service()
class Wing {}

class Bird {
  private wing: Wing

  constructor () {
    this.wing = Container.get('Wing')
  }
}
```
è¿™ç§åŠ¨æ€æ³¨å…¥çš„æ€æƒ³å°±æ˜¯ **ä¾èµ–æ³¨å…¥**ï¼ˆDI, Dependency Injectionï¼‰ï¼Œå®ƒæ˜¯ IoC çš„ä¸€ç§åº”ç”¨å½¢å¼ã€‚



## NestJS

NestJS çš„ç‰¹ç‚¹æœ‰ï¼š

1. **ä¾èµ–æ³¨å…¥ï¼ˆDIï¼‰**: NestJS å¼ºçƒˆä¾èµ–äºŽä¾èµ–æ³¨å…¥è®¾è®¡æ¨¡å¼ï¼Œè¿™ç§æ¨¡å¼æœ‰åŠ©äºŽæé«˜ä»£ç çš„æ¨¡å—åŒ–å’Œå¯æµ‹è¯•æ€§ã€‚é€šè¿‡ä¾èµ–æ³¨å…¥ï¼ŒNestJS å…è®¸å¼€å‘è€…å®šä¹‰å¯é‡ç”¨çš„æœåŠ¡ï¼ˆprovidersï¼‰ï¼Œå¹¶å°†å®ƒä»¬æ³¨å…¥åˆ°æŽ§åˆ¶å™¨å’Œå…¶ä»–æœåŠ¡ä¸­ï¼Œä»Žè€Œå®žçŽ°äº†æ¾è€¦åˆå’Œé«˜å†…èšçš„è®¾è®¡ã€‚
2. **é¢å‘åˆ‡é¢ç¼–ç¨‹ï¼ˆAOPï¼‰**: NestJS æ”¯æŒé¢å‘åˆ‡é¢ç¼–ç¨‹çš„æ¦‚å¿µï¼Œå…è®¸å¼€å‘è€…é€šè¿‡æ‹¦æˆªå™¨ï¼ˆInterceptorsï¼‰ã€å®ˆå«ï¼ˆGuardsï¼‰ã€è¿‡æ»¤å™¨ï¼ˆFiltersï¼‰å’Œè‡ªå®šä¹‰è£…é¥°å™¨ç­‰æ–¹å¼ï¼Œå°†æŸäº›è¡Œä¸ºæ¨ªåˆ‡åˆ°å¯¹è±¡çš„å±‚æ¬¡ç»“æž„ä¸­ï¼Œä»Žè€Œå¢žå¼ºäº†ä»£ç çš„å¤ç”¨æ€§å’ŒæŠ½è±¡æ€§ã€‚
3. **å‡½æ•°å¼å“åº”å¼ç¼–ç¨‹ï¼ˆFRPï¼‰**: NestJS ä¸Ž RxJS çš„é›†æˆæä¾›äº†å¯¹å‡½æ•°å¼å“åº”å¼ç¼–ç¨‹çš„æ”¯æŒï¼Œä½¿å¾—å¤„ç†å¼‚æ­¥æ“ä½œå’Œäº‹ä»¶æ›´åŠ çµæ´»å’Œå¼ºå¤§ã€‚

NestJS æä¾›ä¸€ä¸ªå±‚æ¬¡æ¸…æ™°ã€æ˜“äºŽç†è§£å’Œæ‰©å±•çš„æ¡†æž¶ï¼Œç»“åˆäº† OOPï¼ˆé¢å‘å¯¹è±¡ç¼–ç¨‹ï¼‰ã€FPï¼ˆå‡½æ•°å¼ç¼–ç¨‹ï¼‰å’Œ FRPï¼ˆå‡½æ•°å¼å“åº”å¼ç¼–ç¨‹ï¼‰çš„æœ€ä½³å®žè·µï¼Œä»¥æ­¤æ¥åˆ›å»ºé«˜æ•ˆã€å¯é å’Œå¯ç»´æŠ¤çš„æœåŠ¡å™¨ç«¯åº”ç”¨ç¨‹åºã€‚



## è£…é¥°å™¨ & å…ƒæ•°æ®

### TS è£…é¥°å™¨

TypeScript çš„è£…é¥°å™¨å®žçŽ°äº†å¯¹ç±»åž‹ï¼ˆè¿™é‡Œæ˜¯æŒ‡ TypeScript çš„ç±»åž‹ï¼‰çš„å…ƒæ•°æ®æ³¨å…¥ï¼Œä½¿å¾—ç¨‹åºåœ¨è¿è¡Œæ—¶ä¹Ÿèƒ½åŽ»æ£€æŸ¥å…¶ç±»åž‹ç›¸å…³ä¿¡æ¯ã€‚

TypeScript è£…é¥°å™¨ä¸»è¦æœ‰ï¼š
- æ–¹æ³•è£…é¥°å™¨
- ç±»è£…é¥°å™¨
- å±žæ€§è£…é¥°å™¨
- å‚æ•°è£…é¥°å™¨
- Accessor è£…é¥°å™¨

å…³äºŽ TypeScript è£…é¥°å™¨ç›¸å…³å¯ä»¥ç§»æ­¥ï¼š[Decorators & metadata reflection in TypeScript: From Novice to Expert (Part I)](https://www.wolksoftware.com/blog/decorators-reflection-javascript-typescript)

### å…ƒæ•°æ®åå°„

Reflect Metadata æ˜¯ ES7 çš„ä¸€ä¸ªææ¡ˆï¼Œå®ƒä¸»è¦ç”¨æ¥åœ¨å£°æ˜Žçš„æ—¶å€™æ·»åŠ å’Œè¯»å–å…ƒæ•°æ®ã€‚å…ƒæ•°æ®åå°„ä¸»è¦ç”¨æ¥åœ¨å£°æ˜Žçš„æ—¶å€™æ·»åŠ å’Œè¯»å–å…ƒæ•°æ®ï¼Œå¦‚ï¼š
- å®žä¾‹çš„åå­—
- å®žä¾‹çš„ç±»åž‹
- å®žä¾‹å®žçŽ°çš„æŽ¥å£
- å®žä¾‹çš„å±žæ€§åå­—å’Œç±»åž‹
- å®žä¾‹æž„é€ å‡½æ•°çš„å‚æ•°åå’Œç±»åž‹

Reflect Metadata çš„ API å¯ä»¥ç”¨äºŽç±»æˆ–è€…ç±»çš„å±žæ€§ä¸Šï¼Œå¦‚ï¼š
```ts
function metadata(
  metadataKey: any,
  metadataValue: any
): {
  (target: Function): void;
  (target: Object, propertyKey: string | symbol): void;
};
```

Reflect Metadata å†…ç½®äº†ä¸‰ä¸ªå…ƒæ•°æ®ç±»åž‹ï¼š
- ç±»åž‹å…ƒæ•°æ® **"design:type"**
- å‚æ•°ç±»åž‹å…ƒæ•°æ® **"design:paramtypes"**
- è¿”å›žå€¼ç±»åž‹å…ƒæ•°æ® **"design:returntype"**



## ä»£ç å®žçŽ°

å¯åŠ¨æœåŠ¡ï¼š

```bash
npm run dev
```

è®¿é—®æŽ¥å£ï¼š

```bash
âžœ  ~ curl 'http://localhost:3000/test/get' -v           
*   Trying [::1]:3000...
* Connected to localhost (::1) port 3000
> GET /test/get HTTP/1.1
> Host: localhost:3000
> User-Agent: curl/8.4.0
> Accept: */*
> 
< HTTP/1.1 200 OK
< Date: Tue, 28 May 2024 03:33:59 GMT
< Connection: keep-alive
< Keep-Alive: timeout=5
< Content-Length: 38
< 
* Connection #0 to host localhost left intact
Hello World with GET from TestService!% 
```

